import express from 'express'
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'
import dotenv from 'dotenv'

dotenv.config()

// -----------------------------
// Bi·∫øn h·ªá th·ªëng
// -----------------------------
const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const isProd = process.env.NODE_ENV === 'production'

// -----------------------------
// Server kh·ªüi t·∫°o
// -----------------------------
async function startServer() {
  const app = express()
  app.use(express.json())

  // -----------------------------
  // Import router API (vnpay) - PH·∫¢I LOAD TR∆Ø·ªöC VITE
  // Load t·ª´ ngo√†i src ƒë·ªÉ tr√°nh Vite scan
  // -----------------------------
  try {
    const apiDir = isProd ? path.resolve(__dirname, '../api') : path.resolve(__dirname, '../api')
    const vnpayPath = path.join(apiDir, 'vnpay.js')

    // Convert Windows path to file:// URL
    const vnpayUrl = new URL(`file:///${vnpayPath.replace(/\\/g, '/')}`).href
    const { default: vnpayRouter } = await import(vnpayUrl)
    app.use('/api', vnpayRouter)
    console.log('‚úÖ VNPay router loaded successfully from:', vnpayPath)
  } catch (err) {
    console.error('‚ö†Ô∏è Kh√¥ng th·ªÉ load module vnpay.js:', err)
  }

  // -----------------------------
  // Middleware Vite cho DEV
  // -----------------------------
  let vite
  if (!isProd) {
    const { createServer: createViteServer } = await import('vite')
    vite = await createViteServer({
      server: { middlewareMode: true },
      appType: 'custom'
    })
    app.use(vite.middlewares)
  } else {
    // -----------------------------
    // Static assets cho PROD
    // -----------------------------
    const compression = (await import('compression')).default
    const serveStatic = (await import('serve-static')).default
    app.use(compression())
    app.use(serveStatic(path.resolve(__dirname, '../client'), { index: false }))
  }

  // -----------------------------
  // X·ª≠ l√Ω SSR (Ch·ªâ enable trong production)
  // -----------------------------
  app.use(async (req, res, next) => {
    if (req.url.startsWith('/api')) return next()

    try {
      const url = req.originalUrl
      const root = path.resolve(__dirname, '..')

      const templatePath = isProd ? path.join(root, 'client/index.html') : path.join(root, 'index.html')

      let template = fs.readFileSync(templatePath, 'utf-8')

      if (!isProd && vite) {
        template = await vite.transformIndexHtml(url, template)
      }

      // CSR in dev, SSR in production
      if (isProd) {
        try {
          const render = (await import('./entry-server.js')).render
          const appHtml = await render(url)
          let html = template.replace('<!--app-html-->', appHtml)
          // Find the manifest to get the correct hashed entry file
          const manifestPath = path.join(root, 'client/.vite/manifest.json')
          if (fs.existsSync(manifestPath)) {
            const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'))
            const entry = manifest['src/entry-client.tsx']
            if (entry) {
              html = html.replace('<!--app-script-->', `<script type="module" src="/${entry.file}"></script>`)
            }
          }
          res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
        } catch (ssrError) {
          console.warn('‚ö†Ô∏è SSR failed, using CSR:', ssrError.message)
          let html = template.replace('<!--app-html-->', '<div id="root"></div>')
          html = html.replace('<!--app-script-->', '<script type="module" src="/src/entry-client.tsx"></script>')
          res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
        }
      } else {
        // Dev mode: Always use CSR for faster HMR
        let html = template.replace('<!--app-html-->', '<div id="root"></div>')
        html = html.replace('<!--app-script-->', '<script type="module" src="/src/entry-client.tsx"></script>')
        res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
      }
    } catch (err) {
      !isProd && vite?.ssrFixStacktrace(err)
      console.error('‚ùå Server Error:', err)
      res.status(500).end('Internal Server Error')
    }
  })

  // -----------------------------
  // Kh·ªüi ƒë·ªông server
  // -----------------------------
  const port = process.env.PORT || 3000
  app.listen(port, () => {
    console.log(`üöÄ Server running at http://localhost:${port}`)
  })
}

startServer().catch((err) => {
  console.error('üí• Failed to start server:', err)
})
